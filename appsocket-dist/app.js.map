{"version":3,"sources":["../appsocket/app.js"],"names":["randomstring","require","app","http","Server","io","compiler","process","env","DEV","use","urlencoded","json","noInfo","publicPath","output","rooms","users","get","req","res","sendFile","__dirname","resolve","DisconnectRoom","socket","roomId","id","targetRoom","find","room","leave","checkRoomId","checkReq","isUndefined","isEmpty","resp","error","success","status","message","roomClass","params","_MAX","_ID","_MEMBERS","user","reject","map","u","Error","push","remove","member","user_count","on","data","emit","uid","console","log","roomID","generate","roomTitle","checkResult","addMember","then","join","catch","removeMember","to","next","listen","PORT","err"],"mappings":"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","file":"app.js","sourcesContent":["/**\n * @flow\n */\nimport Express from 'express';\nimport httpModule from 'http';\nimport socketIO from 'socket.io';\nimport cors from 'cors';\nimport multipartyMiddleware from 'connect-multiparty';\nimport bodyParser from 'body-parser';\nimport _ from 'lodash';\nimport logger from 'morgan';\nimport routers from './routers';\nimport path from 'path';\nimport webpack from 'webpack';\nimport config from '../webpack-dev-server.config';\n\nconst randomstring = require(\"randomstring\");\n\nconst app = Express();\nconst http = httpModule.Server(app);\nconst io = socketIO(http);\nconst compiler = webpack(config);\n\nif (process.env.DEV === 'true') {\n    app.use(logger('dev'));\n}\n\napp.use(bodyParser.urlencoded());\napp.use(multipartyMiddleware());\napp.use(bodyParser.json())\n\napp.use(require('webpack-dev-middleware')(compiler, {\n    noInfo: true,\n    publicPath: config.output.publicPath\n}));\n\napp.use(require('webpack-hot-middleware')(compiler));\n\napp.use('/rooms', routers.rooms);\napp.use('/users', routers.users);\n\napp.get('/chatroom', function (req, res) {\n    res.sendFile(__dirname + '/index.html');\n});\n\napp.get('/', function (req, res) {\n    res.sendFile(path.resolve('') + '/app/index.html');\n});\n\nfunction DisconnectRoom(rooms, socket) {\n    const roomId = socket.id;\n\n    let targetRoom = _.find(rooms, (room) => {\n        return room.id === roomId;\n    });\n    socket.leave(targetRoom.id);\n}\n\nfunction checkRoomId(rooms, roomId) {\n    let checkReq = _.isUndefined(roomId) || _.isEmpty(roomId),\n        resp = {\n            error: null,\n            success: false\n        };\n\n    let targetRoom = _.find(rooms, (room) => {\n        return room.id === roomId;\n    });\n\n    if (checkReq) {\n        resp.error = {\n            status: 404,\n            message: 'roomId 不可為空'\n        };\n    } else if (_.isUndefined(targetRoom)) {\n        resp.error = {\n            status: 404,\n            message: '房間不存在'\n        };\n    } else {\n        resp.success = true;\n        resp.targetRoom = targetRoom;\n    }\n\n    return resp;\n}\n\nclass roomClass {\n    constructor(params) {\n\n        this._MAX = 8;\n        this._ID = params.id;\n        this._MEMBERS = [];\n\n    }\n\n    get id() {\n        return this._ID;\n    }\n\n    addMember(user) {\n        return new Promise((resolve, reject) => {\n            let error = null;\n            this._MEMBERS.map(u => {\n                if (u.id === user.id) {\n                    reject(new Error('使用者已存在'));\n                }\n            });\n            this._MEMBERS.push(user);\n\n            resolve();\n        });\n    }\n\n    removeMember(user) {\n        let error = null;\n\n        return _.remove(this._MEMBERS, (member) => {\n            return member.id === user.id;\n        });\n    }\n}\n\nlet rooms = [];\n\n\nvar user_count = 0;\n\n//當新的使用者連接進來的時候\nio.on('connection', function (socket) {\n\n    socket.on('chat message', function (data) {\n        //console.log(data);\n        //appendMessage(data.username+\":\"+data.msg);\n        io.emit('globalmessage', data);\n    });\n\n    //回傳個人的socket.id\n    socket.emit('getuid', {\n        uid: socket.id\n    });\n\n    // TODO 建立房間\n    socket.on('createroom', (data) => {\n        console.log(data);\n        const roomID = randomstring.generate();\n        const params = {\n            id: roomID,\n            roomTitle: roomTitle\n        };\n\n        const room = new roomClass(params);\n        rooms.push(room);\n        socket.emit('success', {\n            status: 200,\n            roomId: room.id,\n            message: `建立房間${room.id}成功`\n        });\n    });\n\n    // TODO 加入房間\n    socket.on('joinroom', (req) => {\n        const checkResult = checkRoomId(rooms, req.roomId);\n\n        if (checkResult.error) {\n            socket.emit('errorStatus', checkResult.error);\n        } else {\n\n            checkResult.targetRoom.addMember(socket)\n                .then(() => {\n                    socket.join(req.roomId);\n\n                    socket.emit('success', {\n                        status: 200,\n                        message: `使用者${socket.id}已加入成功`\n                    });\n                }).catch(error => {\n                    socket.emit('error', {\n                        status: 404,\n                        message: error.message\n                    });\n                });\n        }\n    });\n\n    // TODO 離開房間\n    socket.on('leaveroom', (req) => {\n\n        const checkResult = checkRoomId(rooms, req.roomId);\n\n        if (checkResult.error) {\n            socket.emit('errorStatus', checkResult.error);\n        } else {\n            checkResult.targetRoom.removeMember(socket);\n            socket.leave(req.roomId);\n            socket.emit('success', {\n                status: 200,\n                message: `${socket.id}已經離開房間`\n            });\n        }\n    });\n    // TODO 發送房間訊息\n\n    socket.on('localmessage', (req) => {\n\n        const checkResult = checkRoomId(rooms, req.roomId);\n\n        if (checkResult.error) {\n            socket.emit('errorStatus', checkResult.error);\n        } else {\n            io.to(req.roomId).emit('localmessage', req.params);\n        }\n    });\n\n    // TODO 發送全域訊息\n\n    socket.on('globalmessage', (req) => {\n        io.emit('globalmessage', req.params);\n    });\n\n    //left\n    // socket.on('disconnect', function () {\n    //     DisconnectRoom(rooms, socket.id);\n    //     io.emit('user left', {\n    //         username: socket.username\n    //     });\n    // });\n\n\n});\n\n//Error Handler\napp.use((error, req, res, next) => {\n    const status = error.status || 500;\n    res.status(status).json({\n        message: error.message\n    });\n});\n\n\n\n//指定port\nhttp.listen(process.env.PORT || 3000, function () {\n    console.log('listening on *:3000');\n});\n\n//Nodejs 奇怪的錯誤防止Process 死掉\nprocess.on('uncaughtException', function (err) {\n    console.log(err);\n})\n"]}